<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <title>오늘 복용 기록</title>
</head>
<body>
<div class="top-bar">
    <div class="top-left"><a th:href="@{/}">홈</a></div>
    <div class="top-right">
        <div th:if="${session.loginMember} != null">
            <span th:text="${session.loginMember.nickname} + ' 님'"></span>
            <a th:href="@{/members/logout}">로그아웃</a>
        </div>
    </div>
</div>

<h1>오늘 복용 기록</h1>

<div class="card-box">

    <!-- 에러 메시지 -->
    <div th:if="${errorMessage}" style="color:#d9534f; font-weight:bold; margin-bottom: 12px;"
         th:text="${errorMessage}">
        에러 메시지
    </div>

    <!-- 영양제 없을 때 -->
    <div th:if="${!hasSupplements}" style="text-align: center;">
        <p>등록된 영양제가 없습니다.</p>
        <a th:href="@{/supplements/new}" class="custom-btn">내 영양제 등록하러 가기</a>
    </div>

    <!-- 영양제 있을 때 -->
    <div th:if="${hasSupplements}">
        <form th:action="@{/intakes/today}" method="post" th:object="${intakeForm}">
            <div class="form-row">
                <label>영양제 선택</label>
                <select th:field="*{supplementId}">
                    <option value="">-- 선택하세요 --</option>
                    <option th:each="s : ${supplements}"
                            th:value="${s.id}"
                            th:text="${s.name}">
                    </option>
                </select>
            </div>

            <div class="form-row" style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                    <label>시간대</label>
                    <select th:field="*{timeSlot}">
                        <option value="MORNING">아침</option>
                        <option value="LUNCH">점심</option>
                        <option value="EVENING">저녁</option>
                        <option value="BEDTIME">취침 전</option>
                    </select>
                </div>

                <div style="flex: 1; display: flex; align-items: center; margin-top: 25px;">
                    <label style="cursor: pointer;">
                        <input type="checkbox" th:field="*{taken}" style="width: auto; margin-right: 5px;">
                        복용 완료
                    </label>
                </div>
            </div>

            <div class="form-row">
                <label>메모</label>
                <textarea th:field="*{memo}" placeholder="특이사항 입력" style="height: 60px;"></textarea>
            </div>

            <div style="text-align: center;">
                <button type="submit" class="custom-btn">기록 추가</button>
            </div>
        </form>
    </div>
</div>

<div class="center-box">

    <!-- ✅ 통계(복용률 소수점 1자리) -->
    <div class="card-box" style="margin-bottom: 20px;">
        <h2 style="margin-top:0;">요약 통계</h2>
        <div style="display:flex; gap: 12px; flex-wrap: wrap;">
            <div style="flex:1; min-width: 180px;">
                <strong>전체 기록 수:</strong>
                <span th:text="${totalLogs}">0</span>
            </div>
            <div style="flex:1; min-width: 180px;">
                <strong>복용 완료:</strong>
                <span th:text="${takenCount}">0</span>
            </div>
            <div style="flex:1; min-width: 180px;">
                <strong>복용률:</strong>
                <span th:text="${#numbers.formatDecimal(takenRate, 1, 1)} + '%'">0.0%</span>
            </div>
        </div>
    </div>

    <h2>오늘의 복용 현황</h2>
    <table class="styled-table">
        <thead>
        <tr>
            <th>영양제</th>
            <th>시간대</th>
            <th>상태</th>
            <th>메모</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="log : ${todayLogs}">
            <td th:text="${log.supplement != null ? log.supplement.name : '-'}">영양제</td>
            <td th:text="${log.timeSlot}">시간대</td>
            <td>
                <span th:if="${log.taken}" style="color: green; font-weight: bold;">완료</span>
                <span th:unless="${log.taken}" style="color: red;">미복용</span>
            </td>
            <td th:text="${log.memo}">메모</td>
        </tr>
        <tr th:if="${#lists.isEmpty(todayLogs)}">
            <td colspan="4">오늘 기록이 없습니다.</td>
        </tr>
        </tbody>
    </table>

    <!-- 상호작용 경고 -->
    <div th:if="${!#lists.isEmpty(interactions)}"
         style="background: #fff0f0; padding: 15px; border-radius: 10px; margin-top: 20px; text-align: left;">
        <h3 style="color: #d9534f; margin: 0 0 10px 0;">⚠️ 상호작용 경고</h3>
        <ul style="list-style: disc; padding-left: 20px;">
            <li th:each="rule : ${interactions}">
                <strong th:text="${rule.severity}"></strong> :
                <span th:text="${rule.message}"></span>
            </li>
        </ul>
    </div>

    <hr style="margin: 40px 0; border: 0; border-top: 1px solid #ddd;">

    <h2>전체 기록 (히스토리)</h2>
    <table class="styled-table">
        <thead>
        <tr>
            <th>날짜</th>
            <th>영양제</th>
            <th>브랜드</th>
            <th>시간대</th>
            <th>상태</th>
            <th>메모</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="log : ${allLogs}">
            <td th:text="${log.date}">2025-12-12</td>
            <td th:text="${log.supplement != null ? log.supplement.name : '-'}">영양제</td>
            <td th:text="${log.supplement != null ? log.supplement.brand : '-'}">브랜드</td>
            <td th:text="${log.timeSlot}">MORNING</td>
            <td th:text="${log.taken} ? '복용' : '미복용'">복용</td>
            <td th:text="${log.memo}">메모</td>
        </tr>
        <tr th:if="${#lists.isEmpty(allLogs)}">
            <td colspan="6">기록이 없습니다.</td>
        </tr>
        </tbody>
    </table>

    <div style="margin-top: 20px;">
        <a th:href="@{/intakes/export}" class="custom-btn btn-gray">CSV 다운로드</a>
    </div>
</div>

</body>
</html>
